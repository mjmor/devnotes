<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <link rel="stylesheet" href="/devnotes/assets/css/just-the-docs-default.css"> <script src="/devnotes/assets/js/vendor/lunr.min.js"></script> <script src="/devnotes/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.8.0 --> <title>Elastic Beanstalk | Max’s Dev Notes</title> <meta name="generator" content="Jekyll v3.9.3" /> <meta property="og:title" content="Elastic Beanstalk" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Max’s Dev Notes is a notebook containing software development notes for web &amp; infrastructure development, data science, and developer operations (devops). Find everything you need in one place." /> <meta property="og:description" content="Max’s Dev Notes is a notebook containing software development notes for web &amp; infrastructure development, data science, and developer operations (devops). Find everything you need in one place." /> <link rel="canonical" href="http://localhost:4000/devnotes/dev-ops/aws/eb" /> <meta property="og:url" content="http://localhost:4000/devnotes/dev-ops/aws/eb" /> <meta property="og:site_name" content="Max’s Dev Notes" /> <meta property="og:type" content="website" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Elastic Beanstalk" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","description":"Max’s Dev Notes is a notebook containing software development notes for web &amp; infrastructure development, data science, and developer operations (devops). Find everything you need in one place.","headline":"Elastic Beanstalk","url":"http://localhost:4000/devnotes/dev-ops/aws/eb"}</script> <!-- End Jekyll SEO tag --> </head> <body> <a class="skip-to-main" href="#main-content">Skip to main content</a> <svg xmlns="http://www.w3.org/2000/svg" class="d-none"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <!-- Feather. MIT License: https://github.com/feathericons/feather/blob/master/LICENSE --> <symbol id="svg-external-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link"> <title id="svg-external-link-title">(external link)</title> <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <!-- Bootstrap Icons. MIT License: https://github.com/twbs/icons/blob/main/LICENSE.md --> <symbol id="svg-copy" viewBox="0 0 16 16"> <title>Copy</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/> <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/> </svg> </symbol> <symbol id="svg-copied" viewBox="0 0 16 16"> <title>Copied</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard-check-fill" viewBox="0 0 16 16"> <path d="M6.5 0A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3Zm3 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3Z"/> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1A2.5 2.5 0 0 1 9.5 5h-3A2.5 2.5 0 0 1 4 2.5v-1Zm6.854 7.354-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708.708Z"/> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header"> <a href="/devnotes/" class="site-title lh-tight"> Max's Dev Notes </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a> </div> <nav aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="/devnotes/" class="nav-list-link">Home</a></li><li class="nav-list-item active"><a href="#" class="nav-list-expander" aria-label="toggle links in DevOps category"> <svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg> </a><a href="/devnotes/dev-ops" class="nav-list-link">DevOps</a><ul class="nav-list"><li class="nav-list-item active"><a href="#" class="nav-list-expander" aria-label="toggle links in AWS category"> <svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg> </a><a href="/devnotes/dev-ops/aws" class="nav-list-link">AWS</a><ul class="nav-list"><li class="nav-list-item active"> <a href="/devnotes/dev-ops/aws/eb" class="nav-list-link active">Elastic Beanstalk</a> </li></ul></li></ul></li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Max's Dev Notes" aria-label="Search Max's Dev Notes" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> </div> <div id="main-content-wrap" class="main-content-wrap"> <nav aria-label="Breadcrumb" class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"> <li class="breadcrumb-nav-list-item"><a href="/devnotes/dev-ops">DevOps</a></li> <li class="breadcrumb-nav-list-item"><a href="/devnotes/dev-ops/aws">AWS</a></li> <li class="breadcrumb-nav-list-item"><span>Elastic Beanstalk</span></li> </ol> </nav> <div id="main-content" class="main-content" role="main"> <h1 class="no_toc" id="aws-elastic-beanstalk"> <a href="#aws-elastic-beanstalk" class="anchor-heading" aria-labelledby="aws-elastic-beanstalk"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> AWS Elastic Beanstalk </h1> <p>Elastic Beanstalk is a platform-as-a-service (PaaS) for hosting web apps. Below are notes on configuring an Elastic Beanstalk environment with a new web app.</p> <h2 class="no_toc text-delta" id="table-of-contents"> <a href="#table-of-contents" class="anchor-heading" aria-labelledby="table-of-contents"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Table of contents </h2> <ol id="markdown-toc"> <li><a href="#configure-your-app-to-run-on-elastic-beanstalk" id="markdown-toc-configure-your-app-to-run-on-elastic-beanstalk">Configure Your App to Run on Elastic Beanstalk</a> <ol> <li><a href="#aligning-environment-software-versions" id="markdown-toc-aligning-environment-software-versions">Aligning Environment Software Versions</a></li> <li><a href="#installing-dependencies-on-elastic-beanstalk" id="markdown-toc-installing-dependencies-on-elastic-beanstalk">Installing Dependencies on Elastic Beanstalk</a></li> </ol> </li> <li><a href="#deploying-your-app" id="markdown-toc-deploying-your-app">Deploying Your App</a></li> <li><a href="#configuring-dns-for-your-app" id="markdown-toc-configuring-dns-for-your-app">Configuring DNS for Your App</a></li> <li><a href="#setup-ssl-on-eb-environment" id="markdown-toc-setup-ssl-on-eb-environment">Setup SSL on EB Environment</a> <ol> <li><a href="#install-certbot" id="markdown-toc-install-certbot">Install Certbot</a></li> <li><a href="#allow-traffic-on-port-443" id="markdown-toc-allow-traffic-on-port-443">Allow Traffic on Port 443</a></li> <li><a href="#donwload-and-configure-certificate" id="markdown-toc-donwload-and-configure-certificate">Donwload and Configure Certificate</a></li> <li><a href="#automatically-renew-the-certificate" id="markdown-toc-automatically-renew-the-certificate">Automatically Renew the Certificate</a></li> </ol> </li> <li><a href="#where-to-look-for-logs" id="markdown-toc-where-to-look-for-logs">Where To Look For Logs</a></li> </ol> <h2 id="configure-your-app-to-run-on-elastic-beanstalk"> <a href="#configure-your-app-to-run-on-elastic-beanstalk" class="anchor-heading" aria-labelledby="configure-your-app-to-run-on-elastic-beanstalk"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Configure Your App to Run on Elastic Beanstalk </h2> <h3 id="aligning-environment-software-versions"> <a href="#aligning-environment-software-versions" class="anchor-heading" aria-labelledby="aligning-environment-software-versions"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Aligning Environment Software Versions </h3> <p>Elastic Beanstalk only supports a <a href="https://docs.aws.amazon.com/elasticbeanstalk/latest/platforms/platforms-supported.html#platforms-supported.ruby">few specific versions</a> for the software used in our web app (e.g. Ruby, Puma Server), so we’ll need to make sure our web app is configured to use those versions as well. Otherwise, we’ll run into app install errors.</p> <p>First, take a look at our Gemfile to check the version of Ruby being used. If the Gemfile isn’t using the correct version (3.0.6 at the time of writing), then install the correct version using <code class="language-plaintext highlighter-rouge">rbenv</code>.</p> <script src="https://gist.github.com/mjmor/bcffe5fafcfaee26513316c3e34ad553.js"></script> <p>Next, update your Gemfile to use that version of Ruby. The easiest way to do this is to let the Gemfile read <code class="language-plaintext highlighter-rouge">.ruby-version</code> file created by <code class="language-plaintext highlighter-rouge">rbenv</code>.</p> <script src="https://gist.github.com/mjmor/3721d53bd4be69a75fceb921dfca24aa.js"></script> <p>Next, check the version of Puma being used. Look for <code class="language-plaintext highlighter-rouge">puma ...</code> in your Gemfile. If the Gemfile isn’t using the correct version (6.2.2 at the time of writing), then update uninstall the old version and reinstall the new version.</p> <script src="https://gist.github.com/mjmor/4562cba67aa2c610d84c3085087522c1.js"></script> <!-- Add notes on install sql-devel. --> <h3 id="installing-dependencies-on-elastic-beanstalk"> <a href="#installing-dependencies-on-elastic-beanstalk" class="anchor-heading" aria-labelledby="installing-dependencies-on-elastic-beanstalk"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Installing Dependencies on Elastic Beanstalk </h3> <p>Elastic Beanstalk uses CentOS on the EC2 instances it spins up, and the default CentOS image is missing some common package dependencies. For example, a default Rails app will need the <code class="language-plaintext highlighter-rouge">sqlite</code> Gem which requires a sqlite development package to create the headers.</p> <p>Elastic Beanstalk allows various <a href="https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/platforms-linux-extend.html">script hooks and configuration files</a> to be included in your app that will customize the CentOS environment during deployment. We can write a <a href="https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/ebextensions.html">YAML configuration file</a> to install the <code class="language-plaintext highlighter-rouge">sqlite-devel</code> dependency from <code class="language-plaintext highlighter-rouge">yum</code> package manager.</p> <script src="https://gist.github.com/mjmor/95360eb32e965df5661787bed908608e.js"></script> <h2 id="deploying-your-app"> <a href="#deploying-your-app" class="anchor-heading" aria-labelledby="deploying-your-app"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Deploying Your App </h2> <p>If you don’t already have an EB environment configured, follow the <a href="https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/using-features.environments.html">guide AWS provides</a> for setting up an EB environment. However, instead of using the sample application option, you can jump right to deploying your app from the environment setup.</p> <p>To deploy your app, create an app source bundle. In the root of your project directory, run the following commands.</p> <script src="https://gist.github.com/mjmor/5023189262d993869382a911b686176c.js"></script> <p>This will generate a app source bundle named <code class="language-plaintext highlighter-rouge">&lt;my-app-source-bundle&gt;.zip</code> in the directory about your app root directory. Use this file as the app source bundle, then use the AWS EB console to ‘Upload and Deploy’ the source bundle.</p> <p>If your Elastic Beanstalk environment goes to into a ‘Warning’ or ‘Critical’ state, see <a href="#where-to-look-for-logs">Where to Look For Logs</a> to debug.</p> <h2 id="configuring-dns-for-your-app"> <a href="#configuring-dns-for-your-app" class="anchor-heading" aria-labelledby="configuring-dns-for-your-app"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Configuring DNS for Your App </h2> <p>By default, the EB environment will serve your app over HTTP (port 80) using a public domain that looks like <code class="language-plaintext highlighter-rouge">&lt;env-name&gt;.&lt;env-prefix&gt;.&lt;region&gt;.elasticbeanstalk.com</code>. If you have a custom domain purchased through a non-AWS provider, this section will walk through routing traffic from your custom domain to your EB environment.</p> <p>First, we’ll use AWS Route 53 to configure our DNS records. Go to <a href="https://us-east-1.console.aws.amazon.com/route53/v2/home#Dashboard">Route 53 console</a>. Create a ‘Hosted Zone’ using your root domain for the ‘Domain Name’.</p> <p>Next, we’ll create alias records to route traffic from our root domain and subdomains to go to our EB environment domain. Go to ‘Hosted Zones’ in Route 53 console and select the hosted zone we just created.</p> <ol> <li>Select ‘Create Record’</li> <li>Leave subdomain blank for the first record we create so we can create a root record</li> <li>Select record type ‘A’</li> <li>Enable ‘Alias’ toggle</li> <li>From the ‘Route traffic to’ dropdown, select ‘Alias to Elastic Beanstalk environment’, the region where your EB environment resides, and finally the public domain of your EB environment.</li> <li>Leave ‘Simple routing’ as the routing policy and ‘Evaluate target health’ enabled.</li> </ol> <p>Finally, we’ll your configure your domain registrar to use Amazons name servers instead of any default name servers they may be using. For example, in Google Domains under DNS select ‘Custom name servers’. Add the four name servers from the AWS Route 53 NS record.</p> <p>Give the records a few minutes to propagate, then <a href="https://blog.dnsimple.com/2017/08/debugging-dns/">use <code class="language-plaintext highlighter-rouge">dig</code> and <code class="language-plaintext highlighter-rouge">whois</code></a> to check that your DNS setup is correct. For example, you can check that your custom domain and EB environment domain point to the same public IP.</p> <script src="https://gist.github.com/mjmor/65ab10cf2afc08cbd70ba1de788575f4.js"></script> <p>If you go to your custom domain in a browser and receive a timeout, it’s probably because browsers are forcing connection to HTTPS (port 443) but EB environments serve only on HTTP (port 80) by default. Read on to <a href="#setup-ssl-on-eb-environment">Setup SSL</a> to install an SSL certificate and serve traffic on port 443.</p> <h2 id="setup-ssl-on-eb-environment"> <a href="#setup-ssl-on-eb-environment" class="anchor-heading" aria-labelledby="setup-ssl-on-eb-environment"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Setup SSL on EB Environment </h2> <p>We’ll use <a href="https://certbot.eff.org/"><code class="language-plaintext highlighter-rouge">certbot</code></a> to automatically install and renew our certs in our EB environment. The general process is as follows:</p> <ol> <li>Install Certbot on our EC2 instances</li> <li>Open 443 port on EC2 instances</li> <li>Download and configure the certificate in Nginx</li> <li>Automatically renew the certificate</li> </ol> <h3 id="install-certbot"> <a href="#install-certbot" class="anchor-heading" aria-labelledby="install-certbot"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Install Certbot </h3> <p>We’ll use our EB configuration files <a href="#installing-dependencies-on-elastic-beanstalk">described earlier</a> to install certbot while bringing up EC2 instances.</p> <script src="https://gist.github.com/mjmor/08ac847f2103d9fd74be29f29be56f0a.js"></script> <h3 id="allow-traffic-on-port-443"> <a href="#allow-traffic-on-port-443" class="anchor-heading" aria-labelledby="allow-traffic-on-port-443"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Allow Traffic on Port 443 </h3> <p>We’ll create another EB configuration file to allow traffic from any IP on port 443.</p> <script src="https://gist.github.com/mjmor/da97ab75320f6b9ce584a669f93d9dc9.js"></script> <h3 id="donwload-and-configure-certificate"> <a href="#donwload-and-configure-certificate" class="anchor-heading" aria-labelledby="donwload-and-configure-certificate"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Donwload and Configure Certificate </h3> <p>We’ll create a script hook to run certbot after Nginx has been installed and configured on the new EC2 instance. The following file is a script hook as opposed to a configuration file, so it should be placed in <code class="language-plaintext highlighter-rouge">.platform/hooks/postdeploy</code> in our app root directory.</p> <script src="https://gist.github.com/mjmor/ab027388778c177d1669822cc37129c2.js"></script> <p>We also have to have an EB configuration file to grant execute permissions to that script hook.</p> <script src="https://gist.github.com/mjmor/3e75f7516798ab38909a8ee1a3b0d551.js"></script> <h3 id="automatically-renew-the-certificate"> <a href="#automatically-renew-the-certificate" class="anchor-heading" aria-labelledby="automatically-renew-the-certificate"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Automatically Renew the Certificate </h3> <p>Finally, we’ll use EB configuration to create a crontab entry to renew the cert every 12 hours.</p> <script src="https://gist.github.com/mjmor/8d08ac780786b408698e4592b7b77f78.js"></script> <p>That’s it! Go ahead and redeploy your app and try connecting to the site. You should see the site being served over port 443 (i.e. a lock icon in the browser).</p> <h2 id="where-to-look-for-logs"> <a href="#where-to-look-for-logs" class="anchor-heading" aria-labelledby="where-to-look-for-logs"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Where To Look For Logs </h2> <p>Here’s a list of EB log file locations and what they contain:</p> <ul> <li><code class="language-plaintext highlighter-rouge">/var/log/eb-engine.log</code> - All deployment steps. If EB configuration or app install fails, the logs will be here.</li> <li><code class="language-plaintext highlighter-rouge">/var/log/cfn-init.log</code> - EB extension configuration logs only.</li> <li><code class="language-plaintext highlighter-rouge">/var/log/eb-hooks.log</code> - EB script hooks.</li> <li><code class="language-plaintext highlighter-rouge">/var/log/puma/</code> - Logs for Puma server.</li> </ul> <p>For a full list of log file locations as well as how to customize locations, see the <a href="https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/using-features.logging.html">AWS guide</a>.</p> </div> </div> <div class="search-overlay"></div> </div> </body> </html>
